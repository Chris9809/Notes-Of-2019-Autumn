# 计算机网络第三章

> @author:yelihu
>
> @time:2019年09月17日
>
> @email:87160265@qq.com

## 数据链路层

数据链路层属于计网的低层，数据链路层主要使用的信道有如下两种

- 点对点信道
- 广播信道

学习点对点信道中的PPP协议以及利用广播信道实现的局域网之前，首先搞懂**什么是数据链路层的三个基本问题**。



***

### 三个基本问题

数据链路层的协议解决的最基本的三个问题分别如下：

- 将数据封装成帧：帧的**首部**和**尾部**用于**封装数据报**，来确定**一个单位**的帧。帧里面包含一个数据字段和若干首部字段。<u>控制字符放在帧的最前面，表示首部的开始。另一个控制字符表示帧的结束。</u>我们将128个ASCII码限定出来33个限定字符，其中的SOH和EOT分别作为控制字符中帧的帧定界符的名称。

- 透明传输：为了防止数据链路层在数据报中找到类似EOT之类的控制字符，对帧的定界造成干扰，我们可以加入字节填充的方法，在数据报里的类似控制消息的字符之前填充一个"转义字符“十六进制为1B，名称为ESC。

- 差错监测：传输过程可能会出现差错，相对于信噪比的概念在差错监测中有个误码率的概念。传送十个"01"出现了一个本该是0的，接收端却收到了1，那么这1个差错除以10，误码率就是

- $$
  \frac{1 }{10}
  $$

  我们**一般**使用**循环冗余检测** *CRC*的方法，来实现差错检测。接收端通过 *CRC*的规则来校验**帧监测序列** *FCS*。实现了差错监测，实现了**一定范围**内的正确。



***

#### CRC的描述

首先要知道，**循环冗余检测** *CRC*这种方法，校验错误的主体是**冗余码**。

>  什么是冗余码？
>
> 冗余码就是为了在数据帧上，为了实现差错检测而附加在数据后面的一小串二进制数字，通常也叫做**帧检验序列** *FCS*。

![image-20190917124505977](/Users/apple/Desktop/MarkDown笔记/文章图片/image-20190917124505977.png)

***

CRC **校验的计算规则如下：**

首先发送端将数据划分为组，若一组K个bit，例如：M = 101001，CRC想要做到的就是在M数字后面加上一个N位的冗余码。最后发送出去的数据和冗余码一共为
$$
K+N （位）
$$
**这N为冗余码，我们可以这样求**

首先强调一点：模2运算是不进位和借位的，详情见教科书*P74*注①

1. 将这个数先左移N位，也就是乘以
   $$
   2^N
   $$
   那么原来的M后面也就是加上了N个0，拓展成了M+N这么长。将这个新的长度的M称为M‘

2. 按照事先约定好的一个数P，这个P的位数为N+1，我们将M'
   $$
   \frac{M'}{P}
   $$
   就能分别得到一个商Q和一个余数R，其中R的位数为N位(为什么呢？比如当M= 1001，N=3，M’ = 1001000，P = 1000，这时候N = 3 ，N+1 = 4）如下**运算①**
   $$
   \frac{M'(M加上N位左移产生的0)}{P}=\frac{1001000}{1101(N+1位)}=1110（商）+011(余数，n位)
   $$

3. 上面就得到了这个除法产生的N位余数，我们将这个余数作为冗余码，拼接在数据M(即1001后面)。这个商在此次运算中没什么用。

4. 最后发出去的数据+冗余码即为：1001011

5. 接收端将此次接收到的数据都除以约定好的P（1101），如下**运算②**
   $$
   \frac{1001111}{1101} = 1111余0(整除)
   $$
   上面的结果显示，经过模2运算校验之后，是整除的(余数为0)，所以校验正确，说明数据在链路中传播的时候，没有收到干扰造成某些位数0变1/1变0。如果不能整除，说明某些位在传播过程中变化。
   
   

**上面计算的详细过程如下**

![image-20190919124211955](/Users/apple/Desktop/MarkDown笔记/文章图片/image-20190919124211955.png)

运算①

![image-20190919124224955](/Users/apple/Desktop/MarkDown笔记/文章图片/image-20190919124224955.png)

运算②

****

> **概念别混淆**
>
> FCS是添加在后面的冗余码，叫做帧检测序列，CRC是这种检错方法。



> 无比特差错（CRC能实现无比特差错）、无传输差错（TCP协议能够实现）的区别和概念



****

## 点对点信道的数据链路层

### 数据链路层和帧

**基本概念**

1. 链路：(link)，一个点到另外一个点的物理线段，中间没有任何节点

2. 数据链路：除了link，要需要一个通讯协议来控制数据传输。实现协议的硬件和软件在一起组成了数据链路。

3. 帧：数据链路层上传输的数据单位是帧

***

### 点对点协议PPP

全程Point-to-Point Protocol点对点协议，目前使用最广泛的数据链路层协议。

#### 特点

![image-20190917081452371](/Users/apple/Desktop/MarkDown笔记/文章图片/image-20190917081452371.png)

端在访问网络层获取IP的时候，就使用PPP协议

**特点如下**

- 简单
- 成帧
- 透明
- 多种网络层协议支持：一个链路，多个网络协议支持
- 多类型链路支持：多类型的链路支持
- 差错监测：接收端丢弃有差错的帧
- 检测连接状态：链路是否正常？
- 最大传送单元：除去首部和尾部，中间的数据的最大大小。太小效率低，太大容错率低，一旦一个bit出错，整个帧全部出错。
- 网络层地址协商机制
- 数据压缩协商



***

#### 组成

- 方法：IP数据报（针对网络层是IP协议）封装到串行的链路上
- 链路控制协议LCP：不依赖上层，负责建立断开连接和设置MRU最大接收单元，设置鉴别协议和监控通信质量
- 一套网络控制协议NCP，用于支持多种网络层协议IP、OSI…等；依赖上层，如果上层是IP，此时的NCP使用的是这一套网络层协议中的IPCP协议。



***

##### 帧的格式

**帧的格式如下**

![image-20190917082938202](/Users/apple/Desktop/MarkDown笔记/文章图片/image-20190917082938202.png)

***

**图上说明，左边首部首先发送，顺序如下**

- 第一个byte是0x7E，固定的填写这个值。F部分是flag标志位，标志这个帧的开始
- 第二个是FF和第二个是03，分别是地址字段和控制字段，按照教科书的意思，这里两个字段没意义。
- 第四个是协议，不同网络层协议填写不同内容的字段，比如当发送的是**IP数据报**的时候，这里的内容是0x0021
- 中间这部分就是需要传输的数据，一般不超过1500byte。
- 尾部第一块称为fcs，上文提及，用于差错检测
- 最后一部分结束位，7E，和开头一样。



> A部分称为地址字段，这里的数据为0xFF，没有实际意义。因为PPP是点对点的协议。



如何实现透明传输的问题，比特填充和零比特填充？

***

##### 透明传输的解决

###### 字节填充

将每一个出现在数据中的0x7E，转变为0x7D和0x5E，如果

***

###### 零比特填充

每出现五个连续的1就填充一个0，来防止被误认为F，这个0在接收端会被删除

![image-20190917085300087](/Users/apple/Desktop/MarkDown笔记/文章图片/image-20190917085300087.png)

> 为什么不使用序号和确认机制？



***

#### 工作状态

用户拨号接入ISP，路由器对拨号确认并建立**物理连接**。

**PPP协议状态转换图如下**

![image-20190917085910947](/Users/apple/Desktop/MarkDown笔记/文章图片/image-20190917085910947.png)

***

### PPP协议总结

- 点对点：需要物理层的额外支持才能实现通信
- PPP最基本的步骤
  - 链路静止：此时没有物理层的连接
  - 链路建立：路由器检测调制解调器发送的信号，开始建立链路控制协议LCP的连接
  - 协商配置选项：开始配置链路上的
    - 最大传送帧长MTU
    - 使用的鉴别协议
    - 不使用帧的开始FLAG字段和数据之间的A、C字段。
  - 鉴别：口令鉴别协议，需要发送方发送身份标识信息
  - 网络层协议：鉴别成功之后，网络控制协议NCP根据不同的网络层协议交换不同的网络控制分组，如果网络层协议是IP，那么使用网络控制协议NCP中控制IP协议的协议IPCP(IP control protocol)，将IPCP分组封装成PPP帧，其中协议字段(AC之后)的值为0x8021
  - 打开链路，两个PPP端点互相发送分组。
- 数据链路层需要处理的三个问题和PPP协议如何处理这三个问题
  - 三个问题
    - 封装
    - 透明传输
    - 差错监测
  - PPP协议如何解决
    - PPP使用PPP专用的帧的格式
    - 透明传输：
      - 字节填充(7D/5D/23...)
      - "0"填充
    - 差错监测：检测接收到的帧，差错出现就丢弃



***

## 广播信道的数据链路层

### 局域网

#### 局域网定义

...

#### 局域网特点

**局域网特点如下**

- 广播特点：比如教师机播放的PPT可以给学生机播放
- 设备位置灵活调整
- 提高了系统的：
  - 可靠性
  - 可用性
  - 生存性

***

#### 局域网拓扑结构

![image-20190917090728684](/Users/apple/Desktop/MarkDown笔记/文章图片/image-20190917090728684.png)

***

- 星型：**单点故障问题严重**，如果中间的集线器HUB坏了...
- 环形
- 总线型



***

#### 媒体共享技术

如何共享信道？**如下两种类型**

**静态划分信道**

- 频分复用
- 时分复用
- 波分复用
- 码分复用

**动态划分信道**

- 随机接入
- 受控接入：多点线路探寻、轮询



***

#### 以太网

十九世纪末有人认为光通过"以太"来传播

**以太网的两个标准**：DIX和IEEE 802.3：将链路层分为两个子层：逻辑链路控制LLC和媒体接入控制MAC(在Win10里面显示的是物理地址，该地址分隔符为"-")

![image-20190917092153590](/Users/apple/Desktop/MarkDown笔记/文章图片/image-20190917092153590.png)



***

##### 适配器的作用

每一网卡在出厂的时候都有一个mac地址分配

![image-20190917092331308](/Users/apple/Desktop/MarkDown笔记/文章图片/image-20190917092331308.png)



并行通信的位宽由电脑是几位的机子决定，32位或者64位



***

##### CSMA/CD协议

最初的以太网都是许多计算机连接在一个bus总线上

![image-20190917092919040](/Users/apple/Desktop/MarkDown笔记/文章图片/image-20190917092919040.png)

一个信号可以发送给所有计算机

如何实现指定一对一接收？加上物理地址 *收件人和发件人*

**缺点**

所有机子都可以截获某一个由A机发往B机的数据。

**为了使得通信更加简便，使用下面两种措施**

- 无连接工作方式，不需要建立连接，对数据帧不做编号，不要求对方发回确认。**特点是：不可靠，对差错做丢弃决定，是否重传由上层（比如TCP协议）决定**
- 使用曼彻斯特Manchester编码，使用编码的跳变决定0/1![image-20190919144120117](/Users/apple/Desktop/MarkDown笔记/文章图片/image-20190919144120117.png)

###### CSMA/CD协议的特点

中文名为：载波监听多点接入/碰撞监测

**协议的执行顺序如下：**

1. 准备发送：**检测信道**是否空闲
2. 载波监听：载波（电信号）发送数据之前，**不断地监测总线**上是否有其他计算机在发送数据，直到检测到信道上空闲为止，如果空闲，保持96**比特时间**内信道空闲之后可以发送数据帧  *是否发生随机接入造成的碰撞*
3. 碰撞检测：两个计算机之间可能发送数据的时间距离较近电磁波在总线上的传播速率有限，当某个计算机监听到总线是空闲的时候，另外一个计算机可能即将发送数据，这样使得载波监听环节可能会出现误判，使得前一个计算机以为总线上没有计算机在发送数据，这样就会造成两个计算机占用信道造成碰撞。为了避免两个计算机发生碰撞，引入碰撞检测机制，计算机**边发送数据边监测信道上的电压大小**，判断是否信道上有另外的计算机在发送数据。一旦发生碰撞，检测到了电压变化，那么立即**停止发送**并发送**人为干扰信号**，等待一段随机长度的时间（一般是r倍512比特时间，随机的算法下面介绍）之后，再次监测回到步骤2，这种两端都采用随机长度时间再次发送，可以使得再次发生碰撞的几率大大降低。

> 为什么是96比特时间，这个时间是帧间最小时间，在接收完一组数据之后，要间隔96比特时间才能继续接受下一帧，为了适配器清理缓存。不至于使链路过于繁忙。



**碰撞检测机制图示**

![image-20190919145836081](/Users/apple/Desktop/MarkDown笔记/文章图片/image-20190919145836081.png)

**图解**

![image-20190919150553276](/Users/apple/Desktop/MarkDown笔记/文章图片/image-20190919150553276.png)

***

###### 重传时机

**重传的延迟时间(随机长度时间段)怎么决定**?

使用阶段二进制指数退避算法

**该算法步骤**

1. 规定基本争用时间为2t

2. 从
   $$
   0-2^k-1
   $$
   中随机取出一个数字r，之后重传的时间就为r*2t

3. 上面的k使用
   $$
   k = min[重传次数，10]
   $$
   可见，重传的次数不超过10的时候，k的值为重传次数

4. 重传次数超过10，最大不能超过16次，超过了向高层报告

**上述过程举例如下**

![image-20190919151902508](/Users/apple/Desktop/MarkDown笔记/文章图片/image-20190919151902508.png)

**最短有效帧长**

![image-20190919152828658](/Users/apple/Desktop/MarkDown笔记/文章图片/image-20190919152828658.png)

**强化碰撞**

![image-20190919153029391](/Users/apple/Desktop/MarkDown笔记/文章图片/image-20190919153029391.png)

###### CSMA/DA协议的执行顺序

1. 准备发送，适配器从网络层获得一个**分组**，加上首部和尾部成为一个以太网帧，存入适配器缓存
2. 检测信道
   1. 信道忙，一直检测
   2. 不忙，再检测96比特时间帧间最小间隔内是不是保持不忙，如果满足上述两个条件，数据立即发送
3. 发送中，并且边发送边监听
   1. 发送过程中碰撞
      1. 停止发送数据
      2. 发送规定人为干扰信号(强化碰撞机制，让所有网内用户知道这里发生碰撞)
      3. 执行二进制指数退避算法，等待r（r随机取）个2t（两个A-B往返）的时间 之后继续检测
         1. 如果空闲，返回上面步骤2.2
         2. 如果不空闲，返回上面步骤2.1，超过16次就上报这个数据到网络层处理，停止重传。
   2. 发送过程中不碰撞，继续发送
4. 发送成功，回到上面步骤1

***

##### 使用集线器的星型拓扑

使用双绞线的以太网采用星型拓扑，采用集线器(hub)，物理层上实现了物理的连接，一个网线一端（RJ-45插头——网线的**水晶头**）接在hub上，一段连接在计算机上。

![image-20190919153848442](/Users/apple/Desktop/MarkDown笔记/文章图片/image-20190919153848442.png)

**图示如上**

***

###### **以太网特点**

无屏蔽双绞线，星型拓扑

集成电路芯片，可靠性高，性价比好

每个站两对双绞线，分别发送和接收

通信距离较短(10BASE-T)，100m左右



###### **集线器的特点**

传统总线型的工作方式在逻辑上一致，使用CSMA/CD

多接口转发器

工作在物理层



###### 以太网信道利用率

![image-20190919154640128](/Users/apple/Desktop/MarkDown笔记/文章图片/image-20190919154640128.png)

- 以太网的距离加以限制
- 帧的长短加以限制



**以太网信道利用率最大值**

![image-20190919155822814](/Users/apple/Desktop/MarkDown笔记/文章图片/image-20190919155822814.png)



***

#### 以太网的MAC层

##### mac层的物理地址

计算机上地址的定义

![image-20190919160048466](/Users/apple/Desktop/MarkDown笔记/文章图片/image-20190919160048466.png)

IEEE规定了48byte MAC全球地址，这个地址不是设备的名字，是这个网络接口的名字，固化在适配器ROM中的地址。

前三位是厂家分配地址，后三位是唯一标识符

> 全球地址和本地地址
>
> MAC地址不允许重复的范围

***

##### 适配器检查mac地址

适配器每次获得一个mac帧，就先用硬件检查MAC帧中的MAC地址

- 如果是本站的，包括**单播，广播，多播**，收下
- 如果不是，丢弃



***

##### MAC帧

**MAC帧的格式**

![image-20190924080634962](/Users/apple/Desktop/MarkDown笔记/文章图片/image-20190924080634962.png)



**MAC帧的组成**

1. 帧头
   1. 同步码：1010…同步接收发送机和接收机的时钟，如果两方不同步，可能会出现一些问题….
      1. 前同步码
      2. 帧开始界定符(101010**11**)：一旦出现11，真正的数据传输即开始
   2. 目的地址：6字节
   3. 源地址：6字节
   4. 类型：2字节
2. 数据：46（以太网最小帧64-18字节的首部尾部）-1500(MTU的大小)
3. FCS



***

**无效的MAC地址**

1. 数据字段长度和长度字段不一致(IEEE 802.3规定的MAC帧第三个字段是长度，如果这个值大于0x0600，那么这个值表示的类型，如果这个值小于这个数，这个值表示长度，并在后面数据上加上逻辑链路控制的LLC子层的LLC帧)
2. 长度不是整数个字节，被8整除
3. FCS校验
4. 长度不在46-1500之间



***

##### 扩展以太网

扩展以太网在数据链路层进行

**使用**

- 网桥(早期)
- 以太网交换机



> 1990年问世的交换式集线器，明显提高以太网的性能
>
> 交换式集线器常称为以太网交换机和第二层交换机，强调这种交换机工作在数据链路层。





***

###### 以太网交换机的特点

- 以太网交换机实质上是多接口网桥
- 24个接口，主机和以太网交换机之间的工作模式为全双工方式
- 以太网交换**可以并行**，工作在物理层的集线器hub是不可以并行发送数据，只能一台数据发送数据。
- 互相通信的主机都是独占传输媒体，可以**无碰撞**的传输数据
- 每一个接口都有**存储器**，可以将到来的帧**缓存**。
- 即插即用、几乎不需要配置，内部有帧交换表(地址表)，通过**自学习算法**主动**建立和维护**这个表
- 专用的交换结构芯片，使用硬件转发。速度比使用软件转发的网桥**快很多**



| 优点               | 缺点 |
| ------------------ | ---- |
| 独享带宽，总容量打 |      |
|                    |      |
|                    |      |



###### 以太网交换机的工作方式

- 存储转发：先缓存再处理
- 直通，按照数据帧的MAC地址决定转发接口，**缺点**是不检查差错。



***

###### 自学习功能

![image-20190924090201487](/Users/apple/Desktop/MarkDown笔记/文章图片/image-20190924090201487.png)

**工作顺序举例**

1. A-B发送一帧，使用网络接口1，交换机内没有这个帧应该转发到那里
2. 接收到A发送数据的源地址，将这个地址MAC**写到表内**
3. 除了1接口以外的所有接口，广播出去这个帧给BCD
4. b/c/d中只有b发现这个帧的目的地址是它自身，于是接收

**如果B还想给A回信**

这个时候表内已经有A-接口1的记录，可以直接向接口1发送，并且记录自己的网络接口

**一段时间后...**

这个表内就记录上了所有的MAC地址对应的网络接口





















